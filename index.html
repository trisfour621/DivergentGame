function nextChallenge() {
  const m = document.getElementById("mission");
  if (current >= challenges.length) {
    showFinalResult();
    return;
  }

  const c = challenges[current];
  const progress = Math.round(((current + 1) / challenges.length) * 100);
  m.innerHTML = `
    <h2>${c.type} Test</h2>
    <p>${c.question}</p>
    ${c.options.map((opt, i) =>
      `<button class="btn" onclick="checkAnswer(${i})">${opt}</button>`
    ).join("")}
    <div style="margin-top:20px;">
      <progress value="${progress}" max="100" style="width:80%; height: 20px;"></progress>
      <p>Progress: ${current + 1} / ${challenges.length}</p>
    </div>
  `;
}

function showFinalResult() {
  const m = document.getElementById("mission");

  // Detect top faction
  let topFaction = "Divergent";
  let max = 0;
  for (const f in factionScore) {
    if (factionScore[f] > max) {
      max = factionScore[f];
      topFaction = f;
    }
  }

  const factionQuotes = {
    Dauntless: "â€˜We believe in bravery. We believe in freedom from fear.â€™",
    Erudite: "â€˜Knowledge is the only logical solution to conflict.â€™",
    Amity: "â€˜Peace. Kindness. Forgiveness. Trust. These are the values that hold us together.â€™",
    Candor: "â€˜Truth makes us transparent. Truth makes us strong.â€™",
    Abnegation: "â€˜Selflessness and service is the path to peace.â€™",
    Divergent: "â€˜You donâ€™t fit just one. Youâ€™re capable of anything.â€™"
  };

  const message = score >= 3
    ? `ðŸ’« Well done, ${player}. You show strength in <b>${topFaction}</b>.<br><br><i>${factionQuotes[topFaction]}</i>`
    : `ðŸ•¶ Mission Failed. Train harder, ${player}.`;

  m.innerHTML = `
    <h2>Mission Complete</h2>
    <p>${message}</p>
    <h3>Final Score: ${score}/5</h3>
    <p><button class="btn" onclick="location.reload()">Play Again</button></p>
  `;
}
